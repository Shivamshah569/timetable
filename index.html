<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimized Timetable Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #3f51b5;
            --secondary: #303f9f;
            --accent: #ff4081;
            --accent2: #7c4dff;
            --accent3: #00bcd4;
            --light: #f5f5f5;
            --dark: #263238;
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        body {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: var(--dark);
            min-height: 100vh;
            padding-bottom: 2rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        header {
            text-align: center;
            padding: 2.5rem 0;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border-radius: 0 0 25px 25px;
            box-shadow: var(--shadow);
            margin-bottom: 2.5rem;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.07)"/></svg>');
            background-size: 100% 100%;
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 18px;
            padding: 2rem;
            margin-bottom: 2.5rem;
            box-shadow: var(--card-shadow);
            transition: transform 0.4s ease, box-shadow 0.4s ease;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            color: var(--secondary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem;
            border-bottom: 3px solid var(--accent);
            font-size: 1.6rem;
            display: flex;
            align-items: center;
        }

        .card-title i {
            margin-right: 0.8rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 1.2rem;
        }

        label {
            margin-bottom: 0.6rem;
            font-weight: 600;
            color: var(--secondary);
        }

        input, select, button, textarea {
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--accent);
            outline: none;
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        button:hover {
            background: #e91e63;
            transform: translateY(-2px);
        }

        button i {
            margin-right: 0.7rem;
        }

        .btn-generate {
            background: var(--secondary);
            padding: 1.2rem 2.5rem;
            font-size: 1.2rem;
            margin: 1.5rem 0;
            border-radius: 12px;
        }

        .btn-generate:hover {
            background: #283593;
            transform: translateY(-3px) scale(1.02);
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
        }

        .timetable-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin: 1.5rem 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            overflow: hidden;
        }

        th, td {
            padding: 1rem;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e9ecef;
        }

        .lunch-break {
            background-color: #fff8e1;
            font-weight: bold;
            color: #ff8f00;
        }

        .lab-period {
            background-color: #e8f5e9;
            font-weight: bold;
        }

        .teacher-card {
            display: flex;
            align-items: center;
            padding: 1.2rem;
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            border-radius: 12px;
            margin-bottom: 0.8rem;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }

        .teacher-card:hover {
            transform: translateX(5px);
        }

        .teacher-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.3rem;
            margin-right: 1.2rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .teacher-info {
            flex-grow: 1;
        }

        .teacher-info h3 {
            margin-bottom: 0.4rem;
            color: var(--secondary);
        }

        .subject-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            background: var(--accent);
            color: white;
            margin: 0.2rem;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .lab {
            background: var(--accent2);
        }

        .extra {
            background: var(--accent3);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }

        .section-btn {
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            background: var(--primary);
        }

        .section-btn.active {
            background: var(--accent);
            transform: scale(1.05);
        }

        .year-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .year-btn {
            padding: 1rem 2rem;
            border-radius: 8px;
            background: var(--primary);
            margin: 0 0.5rem 0.5rem;
        }

        .year-btn.active {
            background: var(--accent);
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .stat-box {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 1.2rem;
            border-radius: 12px;
            text-align: center;
            min-width: 180px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-box h3 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        @media (max-width: 1200px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .card {
                padding: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .controls, .year-tabs {
                flex-direction: column;
                align-items: center;
            }
            
            .section-btn, .year-btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .stats {
                flex-direction: column;
            }
            
            .stat-box {
                width: 100%;
            }
        }

        .animated {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }

        .visible {
            opacity: 1;
            transform: translateY(0);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            flex-direction: column;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .success-message {
            background: var(--accent);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin: 1rem 0;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .teacher-specialization {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .teacher-option {
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .teacher-option:hover {
            border-color: var(--accent);
            background-color: #f0f9f6;
        }

        .teacher-option.selected {
            border-color: var(--accent);
            background-color: #e6f7f2;
        }

        .priority {
            font-weight: bold;
            color: var(--accent);
            margin-top: 0.5rem;
        }

        .subject-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .subject-input {
            display: flex;
            flex-direction: column;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .teacher-management {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .config-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .config-btn {
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
        }
        
        .requirement {
            background: #e8f5e9;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid #4caf50;
        }
        
        .requirement h3 {
            color: #2e7d32;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1><i class="fas fa-calendar-alt"></i> Optimized Timetable Generator</h1>
            <p class="subtitle">No free periods - All 600 classes perfectly allocated across 15 sections</p>
        </div>
    </header>

    <main class="container">
        <div class="card animated">
            <h2 class="card-title"><i class="fas fa-cog"></i> Configuration</h2>
            
            <div class="requirement">
                <h3><i class="fas fa-info-circle"></i> Requirements</h3>
                <p>15 sections (5 per year) × 8 periods/day × 5 days/week = 600 total classes</p>
                <p>Each teacher: max 3 periods/day, 13 periods/week</p>
                <p>No free periods - all slots must be filled with appropriate subjects</p>
            </div>
            
            <div class="year-tabs">
                <button class="year-btn active" data-year="2">2nd Year</button>
                <button class="year-btn" data-year="3">3rd Year</button>
                <button class="year-btn" data-year="4">4th Year</button>
                <button class="year-btn" data-year="teachers">Teacher Management</button>
            </div>
            
            <div class="tab-content active" id="year2-tab">
                <h3 style="margin-bottom: 1rem; color: var(--secondary);">2nd Year Subjects (5 sections)</h3>
                
                <div class="config-controls">
                    <div class="input-group">
                        <label for="year2-major-count">Number of Major Subjects</label>
                        <input type="number" id="year2-major-count" min="1" value="5" max="10">
                    </div>
                    <div class="input-group">
                        <label for="year2-minor-count">Number of Minor Subjects</label>
                        <input type="number" id="year2-minor-count" min="1" value="3" max="10">
                    </div>
                    <div class="input-group">
                        <label for="year2-lab-count">Number of Labs</label>
                        <input type="number" id="year2-lab-count" min="1" value="2" max="5">
                    </div>
                    <button class="config-btn" id="year2-setup-btn"><i class="fas fa-plus"></i> Setup Subjects</button>
                </div>
                
                <div id="year2-subject-inputs" class="subject-inputs">
                    <!-- Subject inputs will be generated here -->
                </div>
            </div>
            
            <div class="tab-content" id="year3-tab">
                <h3 style="margin-bottom: 1rem; color: var(--secondary);">3rd Year Subjects (5 sections)</h3>
                
                <div class="config-controls">
                    <div class="input-group">
                        <label for="year3-major-count">Number of Major Subjects</label>
                        <input type="number" id="year3-major-count" min="1" value="5" max="10">
                    </div>
                    <div class="input-group">
                        <label for="year3-minor-count">Number of Minor Subjects</label>
                        <input type="number" id="year3-minor-count" min="1" value="3" max="10">
                    </div>
                    <div class="input-group">
                        <label for="year3-lab-count">Number of Labs</label>
                        <input type="number" id="year3-lab-count" min="1" value="2" max="5">
                    </div>
                    <button class="config-btn" id="year3-setup-btn"><i class="fas fa-plus"></i> Setup Subjects</button>
                </div>
                
                <div id="year3-subject-inputs" class="subject-inputs">
                    <!-- Subject inputs will be generated here -->
                </div>
            </div>
            
            <div class="tab-content" id="year4-tab">
                <h3 style="margin-bottom: 1rem; color: var(--secondary);">4th Year Subjects (5 sections)</h3>
                
                <div class="config-controls">
                    <div class="input-group">
                        <label for="year4-major-count">Number of Major Subjects</label>
                        <input type="number" id="year4-major-count" min="1" value="5" max="10">
                    </div>
                    <div class="input-group">
                        <label for="year4-minor-count">Number of Minor Subjects</label>
                        <input type="number" id="year4-minor-count" min="1" value="3" max="10">
                    </div>
                    <div class="input-group">
                        <label for="year4-lab-count">Number of Labs</label>
                        <input type="number" id="year4-lab-count" min="1" value="2" max="5">
                    </div>
                    <button class="config-btn" id="year4-setup-btn"><i class="fas fa-plus"></i> Setup Subjects</button>
                </div>
                
                <div id="year4-subject-inputs" class="subject-inputs">
                    <!-- Subject inputs will be generated here -->
                </div>
            </div>
            
            <div class="tab-content" id="teachers-tab">
                <h3 style="margin-bottom: 1rem; color: var(--secondary);">Teacher Management</h3>
                <div class="input-group">
                    <label for="teacherCount">Number of Teachers</label>
                    <input type="number" id="teacherCount" min="15" value="24" max="40">
                </div>
                
                <div id="teacherSpecialization">
                    <h3 style="margin: 1.5rem 0 1rem 0; color: var(--secondary);">Teacher Specialization Setup</h3>
                    <div id="teacherList">
                        <!-- Teacher specialization options will be generated here -->
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <button id="generateBtn" class="btn-generate pulse">
                    <i class="fas fa-cogs"></i> Generate Optimized Timetable
                </button>
            </div>
        </div>

        <div id="timetableCard" class="card animated" style="display: none;">
            <h2 class="card-title"><i class="fas fa-table"></i> Generated Timetable - <span id="currentSection">2nd Year - Section A</span></h2>
            <div class="timetable-container">
                <table>
                    <thead>
                        <tr>
                            <th>Time/Day</th>
                            <th>Monday</th>
                            <th>Tuesday</th>
                            <th>Wednesday</th>
                            <th>Thursday</th>
                            <th>Friday</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Periods will be generated here -->
                    </tbody>
                </table>
            </div>
            
            <div class="year-tabs">
                <button class="year-btn active" data-display-year="2">2nd Year</button>
                <button class="year-btn" data-display-year="3">3rd Year</button>
                <button class="year-btn" data-display-year="4">4th Year</button>
            </div>
            
            <div class="controls">
                <button class="section-btn active" data-year="2" data-section="A">2A</button>
                <button class="section-btn" data-year="2" data-section="B">2B</button>
                <button class="section-btn" data-year="2" data-section="C">2C</button>
                <button class="section-btn" data-year="2" data-section="D">2D</button>
                <button class="section-btn" data-year="2" data-section="E">2E</button>
            </div>
            
            <div class="stats">
                <div class="stat-box">
                    <h3 id="totalClasses">600</h3>
                    <p>Total Classes Weekly</p>
                </div>
                <div class="stat-box">
                    <h3 id="assignedClasses">0</h3>
                    <p>Assigned Classes</p>
                </div>
                <div class="stat-box">
                    <h3 id="teacherLoad">0</h3>
                    <p>Avg. Teacher Load</p>
                </div>
                <div class="stat-box">
                    <h3 id="freePeriods">0</h3>
                    <p>Free Periods</p>
                </div>
            </div>
        </div>

        <div id="teachersCard" class="card animated" style="display: none;">
            <h2 class="card-title"><i class="fas fa-chalkboard-teacher"></i> Teacher Assignments & Workload</h2>
            <div id="teachersList">
                <!-- Teacher cards will be generated here -->
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Animate elements on page load
            const animatedElements = document.querySelectorAll('.animated');
            animatedElements.forEach((el, index) => {
                setTimeout(() => {
                    el.classList.add('visible');
                }, 100 * index);
            });

            // Initialize data
            const subjects = {
                year2: {
                    major: [],
                    minor: [],
                    labs: []
                },
                year3: {
                    major: [],
                    minor: [],
                    labs: []
                },
                year4: {
                    major: [],
                    minor: [],
                    labs: []
                }
            };

            const teachers = [];
            const teacherWorkload = {};
            const timetable = {};
            
            // Initialize timetable for 15 sections (5 per year)
            for (let year = 2; year <= 4; year++) {
                for (let section of ['A', 'B', 'C', 'D', 'E']) {
                    const key = `year${year}-${section}`;
                    timetable[key] = Array(5).fill().map(() => Array(8).fill(null));
                }
            }

            // Tab functionality
            document.querySelectorAll('.year-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const year = this.dataset.year;
                    
                    // Hide all tabs and remove active class from buttons
                    document.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('.year-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Show selected tab and set button as active
                    document.getElementById(`${year === 'teachers' ? 'teachers' : 'year' + year}-tab`).classList.add('active');
                    this.classList.add('active');
                    
                    if (year === 'teachers') {
                        initTeacherSpecialization(parseInt(document.getElementById('teacherCount').value));
                    }
                });
            });
            
            // Setup subject inputs for each year
            document.getElementById('year2-setup-btn').addEventListener('click', function() {
                setupSubjectInputs(2);
            });
            
            document.getElementById('year3-setup-btn').addEventListener('click', function() {
                setupSubjectInputs(3);
            });
            
            document.getElementById('year4-setup-btn').addEventListener('click', function() {
                setupSubjectInputs(4);
            });
            
            // Setup subject inputs based on counts
            function setupSubjectInputs(year) {
                const majorCount = parseInt(document.getElementById(`year${year}-major-count`).value);
                const minorCount = parseInt(document.getElementById(`year${year}-minor-count`).value);
                const labCount = parseInt(document.getElementById(`year${year}-lab-count`).value);
                
                const container = document.getElementById(`year${year}-subject-inputs`);
                container.innerHTML = '';
                
                // Add major subjects
                for (let i = 1; i <= majorCount; i++) {
                    const div = document.createElement('div');
                    div.className = 'input-group';
                    div.innerHTML = `
                        <label>Major Subject ${i}</label>
                        <input type="text" id="year${year}-major-${i}" placeholder="Enter subject name" value="Major ${i}">
                    `;
                    container.appendChild(div);
                }
                
                // Add minor subjects
                for (let i = 1; i <= minorCount; i++) {
                    const div = document.createElement('div');
                    div.className = 'input-group';
                    div.innerHTML = `
                        <label>Minor Subject ${i}</label>
                        <input type="text" id="year${year}-minor-${i}" placeholder="Enter subject name" value="Minor ${i}">
                    `;
                    container.appendChild(div);
                }
                
                // Add labs
                for (let i = 1; i <= labCount; i++) {
                    const div = document.createElement('div');
                    div.className = 'input-group';
                    div.innerHTML = `
                        <label>Lab ${i}</label>
                        <input type="text" id="year${year}-lab-${i}" placeholder="Enter lab name" value="Lab ${i}">
                    `;
                    container.appendChild(div);
                }
            }
            
            // Initialize subject inputs for all years
            setupSubjectInputs(2);
            setupSubjectInputs(3);
            setupSubjectInputs(4);
            
            // Display year tabs
            document.querySelectorAll('[data-display-year]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const year = this.dataset.displayYear;
                    
                    // Hide all section buttons
                    document.querySelectorAll('.controls .section-btn').forEach(btn => {
                        btn.style.display = 'none';
                    });
                    
                    // Show sections for selected year
                    document.querySelectorAll(`.section-btn[data-year="${year}"]`).forEach(btn => {
                        btn.style.display = 'inline-block';
                    });
                    
                    // Set first section as active
                    const firstSection = document.querySelector(`.section-btn[data-year="${year}"]`);
                    if (firstSection) {
                        document.querySelectorAll('.section-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        firstSection.classList.add('active');
                        displayTimetable(year, firstSection.dataset.section);
                    }
                    
                    // Update active state of year buttons
                    document.querySelectorAll('[data-display-year]').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });

            // Initialize teacher specialization UI
            function initTeacherSpecialization(count) {
                const teacherList = document.getElementById('teacherList');
                teacherList.innerHTML = '';
                
                // Get all subjects from all years
                const allSubjects = getAllSubjects();
                
                for (let i = 1; i <= count; i++) {
                    const teacherDiv = document.createElement('div');
                    teacherDiv.className = 'input-group';
                    
                    teacherDiv.innerHTML = `
                        <label>Teacher ${i} Name</label>
                        <input type="text" id="teacher${i}_name" placeholder="Enter teacher name" value="Teacher ${i}">
                        <label style="margin-top: 1rem;">Specialization Subjects</label>
                        <div class="teacher-specialization">
                            <div class="teacher-option">
                                <strong>Primary Subject</strong>
                                <select id="teacher${i}_subject1">
                                    ${getSubjectOptions(allSubjects)}
                                </select>
                                <div class="priority">Priority 1</div>
                            </div>
                            <div class="teacher-option">
                                <strong>Secondary Subject</strong>
                                <select id="teacher${i}_subject2">
                                    ${getSubjectOptions(allSubjects)}
                                </select>
                                <div class="priority">Priority 2</div>
                            </div>
                            <div class="teacher-option">
                                <strong>Tertiary Subject</strong>
                                <select id="teacher${i}_subject3">
                                    ${getSubjectOptions(allSubjects)}
                                </select>
                                <div class="priority">Priority 3</div>
                            </div>
                        </div>
                    `;
                    
                    teacherList.appendChild(teacherDiv);
                }
            }

            // Get all subjects from all years
            function getAllSubjects() {
                const allSubjects = [];
                
                for (let year = 2; year <= 4; year++) {
                    const majorCount = parseInt(document.getElementById(`year${year}-major-count`).value);
                    const minorCount = parseInt(document.getElementById(`year${year}-minor-count`).value);
                    const labCount = parseInt(document.getElementById(`year${year}-lab-count`).value);
                    
                    for (let i = 1; i <= majorCount; i++) {
                        const subject = document.getElementById(`year${year}-major-${i}`)?.value;
                        if (subject && !allSubjects.includes(subject)) allSubjects.push(subject);
                    }
                    for (let i = 1; i <= minorCount; i++) {
                        const subject = document.getElementById(`year${year}-minor-${i}`)?.value;
                        if (subject && !allSubjects.includes(subject)) allSubjects.push(subject);
                    }
                    for (let i = 1; i <= labCount; i++) {
                        const lab = document.getElementById(`year${year}-lab-${i}`)?.value;
                        if (lab && !allSubjects.includes(lab)) allSubjects.push(lab);
                    }
                }
                
                return allSubjects;
            }

            // Get subject options for dropdown
            function getSubjectOptions(allSubjects) {
                return allSubjects.map(subj => `<option value="${subj}">${subj}</option>`).join('');
            }

            // Generate teachers with their specializations
            function generateTeachers(count) {
                teachers.length = 0;
                
                for (let i = 1; i <= count; i++) {
                    const name = document.getElementById(`teacher${i}_name`).value;
                    
                    // Get selected subjects from UI
                    const subject1 = document.getElementById(`teacher${i}_subject1`).value;
                    const subject2 = document.getElementById(`teacher${i}_subject2`).value;
                    const subject3 = document.getElementById(`teacher${i}_subject3`).value;
                    
                    teachers.push({
                        id: i,
                        name: name,
                        subjects: [subject1, subject2, subject3],
                        maxPeriodsPerDay: 3,
                        maxPeriodsPerWeek: 13,
                        assignedPeriods: 0,
                        dailyLoad: [0, 0, 0, 0, 0] // Monday to Friday
                    });
                    
                    // Initialize workload tracking
                    teacherWorkload[i] = 0;
                }
            }

            // Collect subjects from input fields
            function collectSubjects() {
                for (let year = 2; year <= 4; year++) {
                    subjects[`year${year}`].major = [];
                    subjects[`year${year}`].minor = [];
                    subjects[`year${year}`].labs = [];
                    
                    const majorCount = parseInt(document.getElementById(`year${year}-major-count`).value);
                    const minorCount = parseInt(document.getElementById(`year${year}-minor-count`).value);
                    const labCount = parseInt(document.getElementById(`year${year}-lab-count`).value);
                    
                    for (let i = 1; i <= majorCount; i++) {
                        const subject = document.getElementById(`year${year}-major-${i}`)?.value;
                        if (subject) subjects[`year${year}`].major.push(subject);
                    }
                    for (let i = 1; i <= minorCount; i++) {
                        const subject = document.getElementById(`year${year}-minor-${i}`)?.value;
                        if (subject) subjects[`year${year}`].minor.push(subject);
                    }
                    for (let i = 1; i <= labCount; i++) {
                        const lab = document.getElementById(`year${year}-lab-${i}`)?.value;
                        if (lab) subjects[`year${year}`].labs.push(lab);
                    }
                }
            }

            // Generate timetable
            function generateTimetable() {
                collectSubjects();
                const teacherCount = parseInt(document.getElementById('teacherCount').value);
                generateTeachers(teacherCount);
                
                // Show loading
                const timetableCard = document.getElementById('timetableCard');
                const teachersCard = document.getElementById('teachersCard');
                timetableCard.style.display = 'block';
                teachersCard.style.display = 'block';
                
                // Show loading state
                const generateBtn = document.getElementById('generateBtn');
                generateBtn.innerHTML = '<div class="spinner"></div> Generating...';
                
                // Generate timetable after a short delay to show loading animation
                setTimeout(() => {
                    // Generate timetable for all sections
                    for (let year = 2; year <= 4; year++) {
                        for (let section of ['A', 'B', 'C', 'D', 'E']) {
                            generateSectionTimetable(year, section);
                        }
                    }
                    
                    // Display timetable for first section
                    displayTimetable(2, 'A');
                    
                    // Display teachers
                    displayTeachers();
                    
                    // Update stats
                    updateStats();
                    
                    // Restore generate button
                    generateBtn.innerHTML = '<i class="fas fa-cogs"></i> Generate Optimized Timetable';
                    
                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'success-message';
                    successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Timetable generated successfully! All 600 classes allocated with no free periods.';
                    document.getElementById('timetableCard').prepend(successMsg);
                    
                    setTimeout(() => {
                        successMsg.remove();
                    }, 5000);
                }, 1000);
            }

            // Generate timetable for a specific section
            function generateSectionTimetable(year, section) {
                const key = `year${year}-${section}`;
                
                // Reset timetable for this section
                timetable[key] = Array(5).fill().map(() => Array(8).fill(null));
                
                // Get subjects for this year
                const majorSubjects = [...subjects[`year${year}`].major];
                const minorSubjects = [...subjects[`year${year}`].minor];
                const labs = [...subjects[`year${year}`].labs];
                
                // Calculate required classes per subject type
                const totalPeriods = 5 * 8; // 5 days, 8 periods each
                const labPeriods = labs.length * 2; // Each lab requires 2 consecutive periods
                const remainingPeriods = totalPeriods - labPeriods - 5; // Subtract labs and lunch breaks
                
                // Distribute remaining periods between major and minor subjects (70% major, 30% minor)
                const majorPeriods = Math.floor(remainingPeriods * 0.7 / majorSubjects.length) * majorSubjects.length;
                const minorPeriods = Math.floor(remainingPeriods * 0.3 / minorSubjects.length) * minorSubjects.length;
                
                // Create subject distribution
                const subjectDistribution = [];
                
                // Add major subjects
                for (const subject of majorSubjects) {
                    const count = majorPeriods / majorSubjects.length;
                    for (let i = 0; i < count; i++) {
                        subjectDistribution.push(subject);
                    }
                }
                
                // Add minor subjects
                for (const subject of minorSubjects) {
                    const count = minorPeriods / minorSubjects.length;
                    for (let i = 0; i < count; i++) {
                        subjectDistribution.push(subject);
                    }
                }
                
                // Shuffle the distribution
                shuffleArray(subjectDistribution);
                
                // Assign subjects to periods
                let subjectIndex = 0;
                
                for (let day = 0; day < 5; day++) {
                    // Track which labs we've scheduled to avoid duplicates
                    const scheduledLabs = [];
                    
                    for (let period = 0; period < 8; period++) {
                        // Skip if already assigned
                        if (timetable[key][day][period]) continue;
                        
                        // Skip period 4 (lunch break)
                        if (period === 4) {
                            timetable[key][day][period] = {
                                subject: "LUNCH BREAK",
                                teacher: "-",
                                teacherId: null,
                                isBreak: true
                            };
                            continue;
                        }
                        
                        // Schedule labs in consecutive periods (2 periods)
                        if (period <= 6 && scheduledLabs.length < labs.length) {
                            // Find a lab that hasn't been scheduled today
                            const availableLabs = labs.filter(lab => !scheduledLabs.includes(lab));
                            if (availableLabs.length > 0) {
                                const lab = availableLabs[Math.floor(Math.random() * availableLabs.length)];
                                scheduledLabs.push(lab);
                                
                                // Schedule lab for two consecutive periods
                                const teacher = findAvailableTeacher(lab, day, period, key);
                                if (teacher) {
                                    timetable[key][day][period] = {
                                        subject: lab,
                                        teacher: teacher.name,
                                        teacherId: teacher.id,
                                        isLab: true
                                    };
                                    
                                    timetable[key][day][period+1] = {
                                        subject: lab + " (Cont.)",
                                        teacher: teacher.name,
                                        teacherId: teacher.id,
                                        isLab: true
                                    };
                                    
                                    // Update teacher workload for both periods
                                    teacher.assignedPeriods += 2;
                                    teacher.dailyLoad[day] += 2;
                                    teacherWorkload[teacher.id] += 2;
                                }
                                continue;
                            }
                        }
                        
                        // Assign regular subjects
                        if (subjectIndex < subjectDistribution.length) {
                            const subject = subjectDistribution[subjectIndex++];
                            const teacher = findAvailableTeacher(subject, day, period, key);
                            
                            if (teacher) {
                                timetable[key][day][period] = {
                                    subject: subject,
                                    teacher: teacher.name,
                                    teacherId: teacher.id
                                };
                                
                                // Update teacher workload
                                teacher.assignedPeriods++;
                                teacher.dailyLoad[day]++;
                                teacherWorkload[teacher.id]++;
                            }
                        }
                    }
                }
            }

            // Fisher-Yates shuffle algorithm
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // Find available teacher for a subject
            function findAvailableTeacher(subject, day, period, sectionKey) {
                // Filter teachers who can teach this subject
                const eligibleTeachers = teachers.filter(teacher => 
                    teacher.subjects.includes(subject) && 
                    teacher.assignedPeriods < teacher.maxPeriodsPerWeek &&
                    teacher.dailyLoad[day] < teacher.maxPeriodsPerDay &&
                    !isTeacherBusy(teacher.id, day, period, sectionKey)
                );
                
                if (eligibleTeachers.length === 0) return null;
                
                // Sort by workload (least loaded first)
                eligibleTeachers.sort((a, b) => a.assignedPeriods - b.assignedPeriods);
                
                return eligibleTeachers[0];
            }

            // Check if teacher is already busy at this time
            function isTeacherBusy(teacherId, day, period, currentSection) {
                for (const sectionKey in timetable) {
                    if (sectionKey === currentSection) continue;
                    
                    if (timetable[sectionKey][day][period] && 
                        timetable[sectionKey][day][period].teacherId === teacherId) {
                        return true;
                    }
                }
                return false;
            }

            // Display timetable for a section
            function displayTimetable(year, section) {
                const key = `year${year}-${section}`;
                const timetableBody = document.querySelector('#timetableCard tbody');
                timetableBody.innerHTML = '';
                
                // Update title
                document.getElementById('currentSection').textContent = `Year ${year} - Section ${section}`;
                
                // Update section buttons
                document.querySelectorAll('.section-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.year == year && btn.dataset.section === section) {
                        btn.classList.add('active');
                    }
                });
                
                // Generate periods (8 per day)
                for (let period = 0; period < 8; period++) {
                    const row = document.createElement('tr');
                    
                    // Time label based on period number
                    let timeLabel = '';
                    switch(period) {
                        case 0: timeLabel = '8:00-9:00'; break;
                        case 1: timeLabel = '9:00-10:00'; break;
                        case 2: timeLabel = '10:00-11:00'; break;
                        case 3: timeLabel = '11:00-12:00'; break;
                        case 4: timeLabel = '12:00-1:00'; break;
                        case 5: timeLabel = '1:00-2:00'; break;
                        case 6: timeLabel = '2:00-3:00'; break;
                        case 7: timeLabel = '3:00-4:00'; break;
                    }
                    
                    row.innerHTML = `<td>${timeLabel}</td>`;
                    
                    // Add subjects for each day
                    for (let day = 0; day < 5; day++) {
                        const cell = timetable[key][day][period];
                        if (cell) {
                            if (cell.isBreak) {
                                row.innerHTML += `<td class="lunch-break">${cell.subject}<br><small>${cell.teacher}</small></td>`;
                            } else if (cell.isLab) {
                                row.innerHTML += `<td class="lab-period">${cell.subject}<br><small>${cell.teacher}</small></td>`;
                            } else {
                                row.innerHTML += `<td>${cell.subject}<br><small>${cell.teacher}</small></td>`;
                            }
                        } else {
                            // This should not happen in the optimized version
                            row.innerHTML += '<td class="free-period">Free<br><small>Error in scheduling</small></td>';
                        }
                    }
                    
                    timetableBody.appendChild(row);
                }
                
                // Update stats
                updateStats();
            }

            // Display teachers in the teachers card
            function displayTeachers() {
                const teachersList = document.getElementById('teachersList');
                teachersList.innerHTML = '';
                
                teachers.forEach(teacher => {
                    const teacherCard = document.createElement('div');
                    teacherCard.className = 'teacher-card';
                    
                    teacherCard.innerHTML = `
                        <div class="teacher-avatar">${teacher.name.charAt(0)}</div>
                        <div class="teacher-info">
                            <h3>${teacher.name} (${teacher.assignedPeriods}/${teacher.maxPeriodsPerWeek})</h3>
                            <div>
                                ${teacher.subjects.map((subj, index) => 
                                    `<span class="subject-badge ${isLab(subj) ? 'lab' : ''}">${subj}${index === 0 ? ' (P1)' : index === 1 ? ' (P2)' : ' (P3)'}</span>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                    
                    teachersList.appendChild(teacherCard);
                });
            }
            
            // Check if subject is a lab
            function isLab(subject) {
                for (let year = 2; year <= 4; year++) {
                    if (subjects[`year${year}`].labs.includes(subject)) return true;
                }
                return false;
            }

            // Update statistics
            function updateStats() {
                let assignedClasses = 0;
                let freePeriods = 0;
                let totalTeacherLoad = 0;
                
                for (const sectionKey in timetable) {
                    for (let day = 0; day < 5; day++) {
                        for (let period = 0; period < 8; period++) {
                            if (timetable[sectionKey][day][period] && !timetable[sectionKey][day][period].isBreak) {
                                assignedClasses++;
                            } else if (!timetable[sectionKey][day][period] || 
                                      (timetable[sectionKey][day][period] && timetable[sectionKey][day][period].isBreak)) {
                                freePeriods++;
                            }
                        }
                    }
                }
                
                teachers.forEach(teacher => {
                    totalTeacherLoad += teacher.assignedPeriods;
                });
                
                const avgTeacherLoad = teachers.length > 0 ? (totalTeacherLoad / teachers.length).toFixed(1) : 0;
                
                document.getElementById('assignedClasses').textContent = assignedClasses;
                document.getElementById('teacherLoad').textContent = avgTeacherLoad;
                document.getElementById('freePeriods').textContent = freePeriods;
            }

            // Initialize teacher specialization UI
            initTeacherSpecialization(24);

            // Event listeners
            document.getElementById('generateBtn').addEventListener('click', generateTimetable);
            
            // Section switch event listeners
            document.querySelectorAll('.section-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    displayTimetable(parseInt(this.dataset.year), this.dataset.section);
                });
            });
            
            // Teacher count change event
            document.getElementById('teacherCount').addEventListener('change', function() {
                initTeacherSpecialization(parseInt(this.value));
            });
        });
    </script>
</body>
</html>
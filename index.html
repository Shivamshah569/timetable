<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Master - Firebase Integrated</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Import Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-analytics.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCGAV49jA7NBIB0MSHUIWc_1abSrIiRdUo",
            authDomain: "periodperfect-f7909.firebaseapp.com",
            projectId: "periodperfect-f7909",
            storageBucket: "periodperfect-f7909.firebasestorage.app",
            messagingSenderId: "282324074669",
            appId: "1:282324074669:web:fdfaafbdc40fe5b88ec624",
            measurementId: "G-0459NGGPFH"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebase = {
            db, doc, setDoc, getDoc, collection, addDoc, getDocs, updateDoc
        };
        
        console.log("Firebase initialized successfully!");
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #3f51b5;
            --secondary: #303f9f;
            --accent: #ff4081;
            --accent2: #7c4dff;
            --accent3: #00bcd4;
            --light: #f5f5f5;
            --dark: #263238;
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        body {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: var(--dark);
            min-height: 100vh;
            padding-bottom: 2rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        header {
            text-align: center;
            padding: 2.5rem 0;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border-radius: 0 0 25px 25px;
            box-shadow: var(--shadow);
            margin-bottom: 2.5rem;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.07)"/></svg>');
            background-size: 100% 100%;
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .tagline {
            font-size: 1.4rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
            color: #e3f2fd;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 18px;
            padding: 2rem;
            margin-bottom: 2.5rem;
            box-shadow: var(--card-shadow);
            transition: transform 0.4s ease, box-shadow 0.4s ease;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            color: var(--secondary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem;
            border-bottom: 3px solid var(--accent);
            font-size: 1.6rem;
            display: flex;
            align-items: center;
        }

        .card-title i {
            margin-right: 0.8rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 1.2rem;
        }

        label {
            margin-bottom: 0.6rem;
            font-weight: 600;
            color: var(--secondary);
        }

        input, select, button, textarea {
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--accent);
            outline: none;
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        button:hover {
            background: #e91e63;
            transform: translateY(-2px);
        }

        button i {
            margin-right: 0.7rem;
        }

        .btn-generate {
            background: var(--secondary);
            padding: 1.2rem 2.5rem;
            font-size: 1.2rem;
            margin: 1.5rem 0;
            border-radius: 12px;
        }

        .btn-generate:hover {
            background: #283593;
            transform: translateY(-3px) scale(1.02);
        }

        .btn-save {
            background: #4caf50;
            margin-left: 1rem;
        }

        .btn-load {
            background: #ff9800;
            margin-left: 1rem;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
        }

        .timetable-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin: 1.5rem 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            overflow: hidden;
        }

        th, td {
            padding: 1rem;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e9ecef;
        }

        .lunch-break {
            background-color: #fff8e1;
            font-weight: bold;
            color: #ff8f00;
        }

        .lab-period {
            background-color: #e8f5e9;
            font-weight: bold;
        }

        .first-half {
            background-color: #e3f2fd;
        }

        .second-half {
            background-color: #f3e5f5;
        }

        .teacher-card {
            display: flex;
            align-items: center;
            padding: 1.2rem;
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            border-radius: 12px;
            margin-bottom: 0.8rem;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }

        .teacher-card:hover {
            transform: translateX(5px);
        }

        .teacher-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.3rem;
            margin-right: 1.2rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .teacher-info {
            flex-grow: 1;
        }

        .teacher-info h3 {
            margin-bottom: 0.4rem;
            color: var(--secondary);
        }

        .subject-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            background: var(--accent);
            color: white;
            margin: 0.2rem;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .lab {
            background: var(--accent2);
        }

        .extra {
            background: var(--accent3);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }

        .section-btn {
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            background: var(--primary);
        }

        .section-btn.active {
            background: var(--accent);
            transform: scale(1.05);
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .stat-box {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 1.2rem;
            border-radius: 12px;
            text-align: center;
            min-width: 180px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .stat-box:hover {
            transform: translateY(-5px);
        }

        .stat-box h3 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        @media (max-width: 1200px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .card {
                padding: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .section-btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .stats {
                flex-direction: column;
            }
            
            .stat-box {
                width: 100%;
            }

            .tagline {
                font-size: 1.2rem;
            }
        }

        .animated {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }

        .visible {
            opacity: 1;
            transform: translateY(0);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            flex-direction: column;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .success-message {
            background: var(--accent);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin: 1rem 0;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .teacher-specialization {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .teacher-option {
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .teacher-option:hover {
            border-color: var(--accent);
            background-color: #f0f9f6;
        }

        .teacher-option.selected {
            border-color: var(--accent);
            background-color: #e6f7f2;
        }

        .priority {
            font-weight: bold;
            color: var(--accent);
            margin-top: 0.5rem;
        }

        .subject-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .subject-input {
            display: flex;
            flex-direction: column;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .teacher-management {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .config-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .config-btn {
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
        }
        
        .requirement {
            background: #e8f5e9;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid #4caf50;
        }
        
        .requirement h3 {
            color: #2e7d32;
            margin-bottom: 0.5rem;
        }

        .feature-highlight {
            background: linear-gradient(135deg, #ff4081, #7c4dff);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin: 0.5rem 0;
        }

        .branch-indicator {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .section-config {
            background: #f5f5f5;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        .half-preference {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .preference-btn {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: #e0e0e0;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .preference-btn.active {
            background: var(--accent);
            color: white;
        }

        .preference-btn.first-half.active {
            background: #3f51b5;
        }

        .preference-btn.second-half.active {
            background: #ff4081;
        }

        .preference-btn.no-preference.active {
            background: #4caf50;
        }

        .firebase-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            background: #4caf50;
            color: white;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .firebase-status.offline {
            background: #f44336;
        }
    </style>
</head>
<body>
    <div id="firebaseStatus" class="firebase-status">
        <i class="fas fa-circle-notch fa-spin"></i> Connecting to Firebase...
    </div>

    <header>
        <div class="container">
            <h1><i class="fas fa-calendar-alt"></i> Timetable Master</h1>
            <div class="tagline">Firebase Integrated - Your data is now saved automatically!</div>
            <p class="subtitle">Advanced timetable generation with cloud storage and no data loss</p>
        </div>
    </header>

    <main class="container">
        <div class="card animated">
            <h2 class="card-title"><i class="fas fa-cog"></i> Configuration</h2>
            
            <div class="requirement">
                <h3><i class="fas fa-info-circle"></i> Timetable Structure</h3>
                <p>9 periods per day: 4 before lunch, 1 lunch break, 4 after lunch</p>
                <p>Each teacher: max 3 periods/day, 13 periods/week</p>
                <div class="feature-highlight">All data is automatically saved to Firebase Firestore</div>
            </div>
            
            <div class="section-config">
                <h3 style="margin-bottom: 1rem; color: var(--secondary);">Section Configuration</h3>
                
                <div class="config-controls">
                    <div class="input-group">
                        <label for="sectionCount">Number of Sections</label>
                        <input type="number" id="sectionCount" min="1" value="5" max="10">
                    </div>
                    <button class="config-btn" id="setupSectionsBtn"><i class="fas fa-plus"></i> Setup Sections</button>
                </div>
                
                <div id="sectionsContainer">
                    <!-- Section inputs will be generated here -->
                </div>
            </div>
            
            <div id="subjectConfiguration" style="display: none;">
                <h3 style="margin-bottom: 1rem; color: var(--secondary);">Subject Configuration</h3>
                <div id="subjectTabs" class="controls">
                    <!-- Section tabs will be generated here -->
                </div>
                
                <div id="subjectTabContent">
                    <!-- Subject inputs for each section will be generated here -->
                </div>
            </div>
            
            <div id="teacherConfiguration" style="display: none;">
                <h3 style="margin-bottom: 1rem; color: var(--secondary);">Teacher Management</h3>
                <div class="input-group">
                    <label for="teacherCount">Number of Teachers</label>
                    <input type="number" id="teacherCount" min="5" value="15" max="40">
                </div>
                
                <div id="teacherSpecialization">
                    <h3 style="margin: 1.5rem 0 1rem 0; color: var(--secondary);">Teacher Specialization Setup</h3>
                    <div id="teacherList">
                        <!-- Teacher specialization options will be generated here -->
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <button id="generateBtn" class="btn-generate pulse">
                    <i class="fas fa-cogs"></i> Generate Perfect Timetable
                </button>
                <button id="saveBtn" class="btn-generate btn-save">
                    <i class="fas fa-save"></i> Save to Cloud
                </button>
                <button id="loadBtn" class="btn-generate btn-load">
                    <i class="fas fa-download"></i> Load from Cloud
                </button>
            </div>
        </div>

        <div id="timetableCard" class="card animated" style="display: none;">
            <h2 class="card-title"><i class="fas fa-table"></i> Generated Timetable - <span id="currentSection">Section 1</span></h2>
            <div class="timetable-container">
                <table>
                    <thead>
                        <tr>
                            <th>Time/Day</th>
                            <th>Monday</th>
                            <th>Tuesday</th>
                            <th>Wednesday</th>
                            <th>Thursday</th>
                            <th>Friday</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Periods will be generated here -->
                    </tbody>
                </table>
            </div>
            
            <div class="controls" id="sectionButtons">
                <!-- Section buttons will be generated here -->
            </div>
            
            <div class="stats">
                <div class="stat-box">
                    <h3 id="totalClasses">0</h3>
                    <p>Total Classes Weekly</p>
                </div>
                <div class="stat-box">
                    <h3 id="assignedClasses">0</h3>
                    <p>Assigned Classes</p>
                </div>
                <div class="stat-box">
                    <h3 id="teacherLoad">0</h3>
                    <p>Avg. Teacher Load</p>
                </div>
                <div class="stat-box">
                    <h3 id="freePeriods">0</h3>
                    <p>Free Periods</p>
                </div>
            </div>
        </div>

        <div id="teachersCard" class="card animated" style="display: none;">
            <h2 class="card-title"><i class="fas fa-chalkboard-teacher"></i> Teacher Assignments & Workload</h2>
            <div id="teachersList">
                <!-- Teacher cards will be generated here -->
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let sections = [];
        let subjects = {};
        let teachers = [];
        let teacherWorkload = {};
        let timetable = {};
        let firebaseInitialized = false;
        
        // Wait for Firebase to initialize
        const checkFirebase = setInterval(() => {
            if (window.firebase) {
                clearInterval(checkFirebase);
                firebaseInitialized = true;
                document.getElementById('firebaseStatus').innerHTML = '<i class="fas fa-check-circle"></i> Connected to Firebase';
                console.log("Firebase is ready to use");
                
                // Try to load saved data
                setTimeout(loadFromFirebase, 1000);
            }
        }, 100);

        document.addEventListener('DOMContentLoaded', function() {
            // Animate elements on page load
            const animatedElements = document.querySelectorAll('.animated');
            animatedElements.forEach((el, index) => {
                setTimeout(() => {
                    el.classList.add('visible');
                }, 100 * index);
            });

            // Setup sections
            document.getElementById('setupSectionsBtn').addEventListener('click', function() {
                const sectionCount = parseInt(document.getElementById('sectionCount').value);
                setupSections(sectionCount);
            });

            // Save and Load buttons
            document.getElementById('saveBtn').addEventListener('click', saveToFirebase);
            document.getElementById('loadBtn').addEventListener('click', loadFromFirebase);
            
            // Generate timetable button
            document.getElementById('generateBtn').addEventListener('click', generateTimetable);

            // Setup sections based on count
            function setupSections(count) {
                const sectionsContainer = document.getElementById('sectionsContainer');
                sectionsContainer.innerHTML = '';
                sections = [];
                
                for (let i = 1; i <= count; i++) {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'input-group';
                    sectionDiv.innerHTML = `
                        <label>Section ${i} Name</label>
                        <input type="text" id="section-${i}-name" placeholder="Enter section name" value="Section ${i}">
                        <label>Year</label>
                        <select id="section-${i}-year">
                            <option value="2">2nd Year</option>
                            <option value="3">3rd Year</option>
                            <option value="4">4th Year</option>
                        </select>
                    `;
                    
                    sectionsContainer.appendChild(sectionDiv);
                    sections.push({
                        id: `section-${i}`,
                        name: `Section ${i}`,
                        year: 2
                    });
                }
                
                // Show subject configuration
                document.getElementById('subjectConfiguration').style.display = 'block';
                document.getElementById('teacherConfiguration').style.display = 'block';
                setupSubjectTabs(count);
                
                // Initialize teacher specialization
                initTeacherSpecialization(parseInt(document.getElementById('teacherCount').value));
            }

            // Setup subject tabs for each section
            function setupSubjectTabs(sectionCount) {
                const subjectTabs = document.getElementById('subjectTabs');
                const subjectTabContent = document.getElementById('subjectTabContent');
                subjectTabs.innerHTML = '';
                subjectTabContent.innerHTML = '';
                
                for (let i = 1; i <= sectionCount; i++) {
                    // Create tab button
                    const tabButton = document.createElement('button');
                    tabButton.className = 'section-btn' + (i === 1 ? ' active' : '');
                    tabButton.textContent = `Section ${i}`;
                    tabButton.dataset.section = `section-${i}`;
                    tabButton.addEventListener('click', function() {
                        // Activate this tab and deactivate others
                        document.querySelectorAll('#subjectTabs .section-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        this.classList.add('active');
                        
                        // Show this section's content and hide others
                        document.querySelectorAll('.subject-tab-content').forEach(tab => {
                            tab.style.display = 'none';
                        });
                        document.getElementById(`subject-content-${i}`).style.display = 'block';
                    });
                    subjectTabs.appendChild(tabButton);
                    
                    // Create tab content
                    const tabContent = document.createElement('div');
                    tabContent.className = 'subject-tab-content';
                    tabContent.id = `subject-content-${i}`;
                    tabContent.style.display = i === 1 ? 'block' : 'none';
                    
                    tabContent.innerHTML = `
                        <h4 style="margin-bottom: 1rem; color: var(--secondary);">Subjects for Section ${i}</h4>
                        <div class="config-controls">
                            <div class="input-group">
                                <label for="section-${i}-major-count">Number of Major Subjects</label>
                                <input type="number" id="section-${i}-major-count" min="1" value="5" max="10">
                            </div>
                            <div class="input-group">
                                <label for="section-${i}-minor-count">Number of Minor Subjects</label>
                                <input type="number" id="section-${i}-minor-count" min="1" value="3" max="10">
                            </div>
                            <div class="input-group">
                                <label for="section-${i}-lab-count">Number of Labs</label>
                                <input type="number" id="section-${i}-lab-count" min="1" value="2" max="5">
                            </div>
                            <button class="config-btn" id="section-${i}-setup-btn"><i class="fas fa-plus"></i> Setup Subjects</button>
                        </div>
                        <div id="section-${i}-subject-inputs" class="subject-inputs"></div>
                    `;
                    
                    subjectTabContent.appendChild(tabContent);
                    
                    // Add event listener for subject setup button
                    document.getElementById(`section-${i}-setup-btn`).addEventListener('click', function() {
                        setupSectionSubjects(i);
                    });
                }
                
                // Initialize first section's subjects
                setupSectionSubjects(1);
            }

            // Setup subjects for a specific section
            function setupSectionSubjects(sectionNum) {
                const majorCount = parseInt(document.getElementById(`section-${sectionNum}-major-count`).value);
                const minorCount = parseInt(document.getElementById(`section-${sectionNum}-minor-count`).value);
                const labCount = parseInt(document.getElementById(`section-${sectionNum}-lab-count`).value);
                
                const container = document.getElementById(`section-${sectionNum}-subject-inputs`);
                container.innerHTML = '';
                
                // Add major subjects
                for (let i = 1; i <= majorCount; i++) {
                    const div = document.createElement('div');
                    div.className = 'input-group';
                    div.innerHTML = `
                        <label>Major Subject ${i}</label>
                        <input type="text" id="section-${sectionNum}-major-${i}" placeholder="Enter subject name" value="Major ${i}">
                        <label>Period Preference</label>
                        <div class="half-preference">
                            <button type="button" class="preference-btn first-half" data-pref="first">First Half</button>
                            <button type="button" class="preference-btn second-half" data-pref="second">Second Half</button>
                            <button type="button" class="preference-btn no-preference active" data-pref="any">No Preference</button>
                        </div>
                    `;
                    container.appendChild(div);
                    
                    // Add event listeners for preference buttons
                    const buttons = div.querySelectorAll('.preference-btn');
                    buttons.forEach(btn => {
                        btn.addEventListener('click', function() {
                            buttons.forEach(b => b.classList.remove('active'));
                            this.classList.add('active');
                        });
                    });
                }
                
                // Add minor subjects
                for (let i = 1; i <= minorCount; i++) {
                    const div = document.createElement('div');
                    div.className = 'input-group';
                    div.innerHTML = `
                        <label>Minor Subject ${i}</label>
                        <input type="text" id="section-${sectionNum}-minor-${i}" placeholder="Enter subject name" value="Minor ${i}">
                        <label>Period Preference</label>
                        <div class="half-preference">
                            <button type="button" class="preference-btn first-half" data-pref="first">First Half</button>
                            <button type="button" class="preference-btn second-half" data-pref="second">Second Half</button>
                            <button type="button" class="preference-btn no-preference active" data-pref="any">No Preference</button>
                        </div>
                    `;
                    container.appendChild(div);
                    
                    // Add event listeners for preference buttons
                    const buttons = div.querySelectorAll('.preference-btn');
                    buttons.forEach(btn => {
                        btn.addEventListener('click', function() {
                            buttons.forEach(b => b.classList.remove('active'));
                            this.classList.add('active');
                        });
                    });
                }
                
                // Add labs
                for (let i = 1; i <= labCount; i++) {
                    const div = document.createElement('div');
                    div.className = 'input-group';
                    div.innerHTML = `
                        <label>Lab ${i}</label>
                        <input type="text" id="section-${sectionNum}-lab-${i}" placeholder="Enter lab name" value="Lab ${i}">
                        <label>Period Preference</label>
                        <div class="half-preference">
                            <button type="button" class="preference-btn first-half" data-pref="first">First Half</button>
                            <button type="button" class="preference-btn second-half" data-pref="second">Second Half</button>
                            <button type="button" class="preference-btn no-preference active" data-pref="any">No Preference</button>
                        </div>
                    `;
                    container.appendChild(div);
                    
                    // Add event listeners for preference buttons
                    const buttons = div.querySelectorAll('.preference-btn');
                    buttons.forEach(btn => {
                        btn.addEventListener('click', function() {
                            buttons.forEach(b => b.classList.remove('active'));
                            this.classList.add('active');
                        });
                    });
                }
            }

            // Initialize teacher specialization UI
            function initTeacherSpecialization(count) {
                const teacherList = document.getElementById('teacherList');
                teacherList.innerHTML = '';
                
                // Get all subjects from all sections
                const allSubjects = getAllSubjects();
                
                for (let i = 1; i <= count; i++) {
                    const teacherDiv = document.createElement('div');
                    teacherDiv.className = 'input-group';
                    
                    teacherDiv.innerHTML = `
                        <label>Teacher ${i} Name</label>
                        <input type="text" id="teacher${i}_name" placeholder="Enter teacher name" value="Teacher ${i}">
                        <label style="margin-top: 1rem;">Specialization Subjects</label>
                        <div class="teacher-specialization">
                            <div class="teacher-option">
                                <strong>Primary Subject</strong>
                                <select id="teacher${i}_subject1">
                                    ${getSubjectOptions(allSubjects)}
                                </select>
                                <div class="priority">Priority 1</div>
                            </div>
                            <div class="teacher-option">
                                <strong>Secondary Subject</strong>
                                <select id="teacher${i}_subject2">
                                    ${getSubjectOptions(allSubjects)}
                                </select>
                                <div class="priority">Priority 2</div>
                            </div>
                            <div class="teacher-option">
                                <strong>Tertiary Subject</strong>
                                <select id="teacher${i}_subject3">
                                    ${getSubjectOptions(allSubjects)}
                                </select>
                                <div class="priority">Priority 3</div>
                            </div>
                        </div>
                    `;
                    
                    teacherList.appendChild(teacherDiv);
                }
            }

            // Get all subjects from all sections
            function getAllSubjects() {
                const allSubjects = [];
                const sectionCount = parseInt(document.getElementById('sectionCount').value);
                
                for (let i = 1; i <= sectionCount; i++) {
                    const majorCount = parseInt(document.getElementById(`section-${i}-major-count`).value);
                    const minorCount = parseInt(document.getElementById(`section-${i}-minor-count`).value);
                    const labCount = parseInt(document.getElementById(`section-${i}-lab-count`).value);
                    
                    for (let j = 1; j <= majorCount; j++) {
                        const subject = document.getElementById(`section-${i}-major-${j}`)?.value;
                        if (subject && !allSubjects.includes(subject)) allSubjects.push(subject);
                    }
                    for (let j = 1; j <= minorCount; j++) {
                        const subject = document.getElementById(`section-${i}-minor-${j}`)?.value;
                        if (subject && !allSubjects.includes(subject)) allSubjects.push(subject);
                    }
                    for (let j = 1; j <= labCount; j++) {
                        const lab = document.getElementById(`section-${i}-lab-${j}`)?.value;
                        if (lab && !allSubjects.includes(lab)) allSubjects.push(lab);
                    }
                }
                
                return allSubjects;
            }

            // Get subject options for dropdown
            function getSubjectOptions(allSubjects) {
                return allSubjects.map(subj => `<option value="${subj}">${subj}</option>`).join('');
            }

            // Generate teachers with their specializations
            function generateTeachers(count) {
                teachers = [];
                
                for (let i = 1; i <= count; i++) {
                    const name = document.getElementById(`teacher${i}_name`).value;
                    
                    // Get selected subjects from UI
                    const subject1 = document.getElementById(`teacher${i}_subject1`).value;
                    const subject2 = document.getElementById(`teacher${i}_subject2`).value;
                    const subject3 = document.getElementById(`teacher${i}_subject3`).value;
                    
                    teachers.push({
                        id: i,
                        name: name,
                        subjects: [subject1, subject2, subject3],
                        maxPeriodsPerDay: 3,
                        maxPeriodsPerWeek: 13,
                        assignedPeriods: 0,
                        dailyLoad: [0, 0, 0, 0, 0] // Monday to Friday
                    });
                    
                    // Initialize workload tracking
                    teacherWorkload[i] = 0;
                }
            }

            // Collect subjects from input fields
            function collectSubjects() {
                const sectionCount = parseInt(document.getElementById('sectionCount').value);
                subjects = {};
                
                for (let i = 1; i <= sectionCount; i++) {
                    const sectionId = `section-${i}`;
                    subjects[sectionId] = {
                        major: [],
                        minor: [],
                        labs: []
                    };
                    
                    const majorCount = parseInt(document.getElementById(`section-${i}-major-count`).value);
                    const minorCount = parseInt(document.getElementById(`section-${i}-minor-count`).value);
                    const labCount = parseInt(document.getElementById(`section-${i}-lab-count`).value);
                    
                    for (let j = 1; j <= majorCount; j++) {
                        const subject = document.getElementById(`section-${i}-major-${j}`)?.value;
                        const preference = document.querySelector(`#section-${i}-major-${j} .preference-btn.active`).dataset.pref;
                        if (subject) subjects[sectionId].major.push({
                            name: subject,
                            preference: preference
                        });
                    }
                    for (let j = 1; j <= minorCount; j++) {
                        const subject = document.getElementById(`section-${i}-minor-${j}`)?.value;
                        const preference = document.querySelector(`#section-${i}-minor-${j} .preference-btn.active`).dataset.pref;
                        if (subject) subjects[sectionId].minor.push({
                            name: subject,
                            preference: preference
                        });
                    }
                    for (let j = 1; j <= labCount; j++) {
                        const lab = document.getElementById(`section-${i}-lab-${j}`)?.value;
                        const preference = document.querySelector(`#section-${i}-lab-${j} .preference-btn.active`).dataset.pref;
                        if (lab) subjects[sectionId].labs.push({
                            name: lab,
                            preference: preference
                        });
                    }
                }
            }

            // Generate timetable
            function generateTimetable() {
                collectSubjects();
                const teacherCount = parseInt(document.getElementById('teacherCount').value);
                const sectionCount = parseInt(document.getElementById('sectionCount').value);
                
                // Update sections data
                for (let i = 1; i <= sectionCount; i++) {
                    sections[i-1] = {
                        id: `section-${i}`,
                        name: document.getElementById(`section-${i}-name`).value || `Section ${i}`,
                        year: parseInt(document.getElementById(`section-${i}-year`).value)
                    };
                }
                
                generateTeachers(teacherCount);
                
                // Initialize timetable for all sections
                sections.forEach(section => {
                    timetable[section.id] = Array(5).fill().map(() => Array(9).fill(null));
                });

                // Show loading
                const timetableCard = document.getElementById('timetableCard');
                const teachersCard = document.getElementById('teachersCard');
                timetableCard.style.display = 'block';
                teachersCard.style.display = 'block';
                
                // Create section buttons
                const sectionButtons = document.getElementById('sectionButtons');
                sectionButtons.innerHTML = '';
                
                sections.forEach((section, index) => {
                    const button = document.createElement('button');
                    button.className = 'section-btn' + (index === 0 ? ' active' : '');
                    button.textContent = section.name;
                    button.dataset.section = section.id;
                    button.addEventListener('click', function() {
                        document.querySelectorAll('#sectionButtons .section-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        this.classList.add('active');
                        displayTimetable(section.id);
                    });
                    sectionButtons.appendChild(button);
                });
                
                // Show loading state
                const generateBtn = document.getElementById('generateBtn');
                generateBtn.innerHTML = '<div class="spinner"></div> Generating...';
                
                // Generate timetable after a short delay to show loading animation
                setTimeout(() => {
                    // Generate timetable for all sections
                    sections.forEach(section => {
                        generateSectionTimetable(section.id);
                    });
                    
                    // Display timetable for first section
                    displayTimetable(sections[0].id);
                    
                    // Display teachers
                    displayTeachers();
                    
                    // Update stats
                    updateStats();
                    
                    // Restore generate button
                    generateBtn.innerHTML = '<i class="fas fa-cogs"></i> Generate Perfect Timetable';
                    
                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'success-message';
                    successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Timetable generated successfully! All classes allocated with no free periods.';
                    document.getElementById('timetableCard').prepend(successMsg);
                    
                    setTimeout(() => {
                        successMsg.remove();
                    }, 5000);
                    
                    // Auto-save to Firebase
                    saveToFirebase();
                }, 1000);
            }

            // Generate timetable for a specific section
            function generateSectionTimetable(sectionId) {
                // Reset timetable for this section
                timetable[sectionId] = Array(5).fill().map(() => Array(9).fill(null));
                
                // Get subjects for this section
                const majorSubjects = [...subjects[sectionId].major];
                const minorSubjects = [...subjects[sectionId].minor];
                const labs = [...subjects[sectionId].labs];
                
                // Add all subjects together
                const allSubjects = [...majorSubjects, ...minorSubjects, ...labs];
                
                // Calculate total periods (5 days × 9 periods = 45, minus 5 lunch periods = 40)
                const totalPeriods = 5 * 8; // 40 teaching periods
                const labPeriods = labs.length * 2; // Each lab requires 2 consecutive periods
                const remainingPeriods = totalPeriods - labPeriods;
                
                // Distribute remaining periods between major and minor subjects (70% major, 30% minor)
                const majorPeriods = Math.floor(remainingPeriods * 0.7 / majorSubjects.length) * majorSubjects.length;
                const minorPeriods = Math.floor(remainingPeriods * 0.3 / minorSubjects.length) * minorSubjects.length;
                
                // Create subject distribution
                const subjectDistribution = [];
                
                // Add major subjects
                for (const subject of majorSubjects) {
                    const count = majorPeriods / majorSubjects.length;
                    for (let i = 0; i < count; i++) {
                        subjectDistribution.push(subject);
                    }
                }
                
                // Add minor subjects
                for (const subject of minorSubjects) {
                    const count = minorPeriods / minorSubjects.length;
                    for (let i = 0; i < count; i++) {
                        subjectDistribution.push(subject);
                    }
                }
                
                // Shuffle the distribution
                shuffleArray(subjectDistribution);
                
                // Assign subjects to periods
                let subjectIndex = 0;
                
                for (let day = 0; day < 5; day++) {
                    // Track which labs we've scheduled to avoid duplicates
                    const scheduledLabs = [];
                    
                    for (let period = 0; period < 9; period++) {
                        // Skip if already assigned
                        if (timetable[sectionId][day][period]) continue;
                        
                        // Skip period 4 (lunch break)
                        if (period === 4) {
                            timetable[sectionId][day][period] = {
                                subject: "LUNCH BREAK",
                                teacher: "-",
                                teacherId: null,
                                isBreak: true
                            };
                            continue;
                        }
                        
                        // Schedule labs in consecutive periods (2 periods)
                        if (period <= 7 && scheduledLabs.length < labs.length) {
                            // Find a lab that hasn't been scheduled today
                            const availableLabs = labs.filter(lab => !scheduledLabs.includes(lab));
                            if (availableLabs.length > 0) {
                                const lab = availableLabs[Math.floor(Math.random() * availableLabs.length)];
                                scheduledLabs.push(lab);
                                
                                // Schedule lab for two consecutive periods
                                const teacher = findAvailableTeacher(lab.name, day, period, sectionId);
                                if (teacher) {
                                    timetable[sectionId][day][period] = {
                                        subject: lab.name,
                                        teacher: teacher.name,
                                        teacherId: teacher.id,
                                        isLab: true
                                    };
                                    
                                    timetable[sectionId][day][period+1] = {
                                        subject: lab.name + " (Cont.)",
                                        teacher: teacher.name,
                                        teacherId: teacher.id,
                                        isLab: true
                                    };
                                    
                                    // Update teacher workload for both periods
                                    teacher.assignedPeriods += 2;
                                    teacher.dailyLoad[day] += 2;
                                    teacherWorkload[teacher.id] += 2;
                                }
                                continue;
                            }
                        }
                        
                        // Assign regular subjects based on preference
                        if (subjectIndex < subjectDistribution.length) {
                            const subject = subjectDistribution[subjectIndex++];
                            const teacher = findAvailableTeacher(subject.name, day, period, sectionId);
                            
                            if (teacher) {
                                timetable[sectionId][day][period] = {
                                    subject: subject.name,
                                    teacher: teacher.name,
                                    teacherId: teacher.id,
                                    preference: subject.preference
                                };
                                
                                // Update teacher workload
                                teacher.assignedPeriods++;
                                teacher.dailyLoad[day]++;
                                teacherWorkload[teacher.id]++;
                            }
                        }
                    }
                }
            }

            // Fisher-Yates shuffle algorithm
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // Find available teacher for a subject
            function findAvailableTeacher(subject, day, period, sectionId) {
                // Filter teachers who can teach this subject
                const eligibleTeachers = teachers.filter(teacher => 
                    teacher.subjects.includes(subject) && 
                    teacher.assignedPeriods < teacher.maxPeriodsPerWeek &&
                    teacher.dailyLoad[day] < teacher.maxPeriodsPerDay &&
                    !isTeacherBusy(teacher.id, day, period, sectionId)
                );
                
                if (eligibleTeachers.length === 0) return null;
                
                // Sort by workload (least loaded first)
                eligibleTeachers.sort((a, b) => a.assignedPeriods - b.assignedPeriods);
                
                return eligibleTeachers[0];
            }

            // Check if teacher is already busy at this time
            function isTeacherBusy(teacherId, day, period, currentSection) {
                for (const sectionKey in timetable) {
                    if (sectionKey === currentSection) continue;
                    
                    if (timetable[sectionKey][day][period] && 
                        timetable[sectionKey][day][period].teacherId === teacherId) {
                        return true;
                    }
                }
                return false;
            }

            // Display timetable for a section
            function displayTimetable(sectionId) {
                const timetableBody = document.querySelector('#timetableCard tbody');
                timetableBody.innerHTML = '';
                
                // Find section name
                const section = sections.find(s => s.id === sectionId);
                document.getElementById('currentSection').textContent = section ? section.name : sectionId;
                
                // Update section buttons
                document.querySelectorAll('#sectionButtons .section-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.section === sectionId) {
                        btn.classList.add('active');
                    }
                });
                
                // Generate periods (9 per day)
                for (let period = 0; period < 9; period++) {
                    const row = document.createElement('tr');
                    
                    // Time label based on period number
                    let timeLabel = '';
                    switch(period) {
                        case 0: timeLabel = '8:00-8:45'; break;
                        case 1: timeLabel = '8:45-9:30'; break;
                        case 2: timeLabel = '9:30-10:15'; break;
                        case 3: timeLabel = '10:15-11:00'; break;
                        case 4: timeLabel = '11:00-11:45'; break;
                        case 5: timeLabel = '11:45-12:30'; break;
                        case 6: timeLabel = '12:30-1:15'; break;
                        case 7: timeLabel = '1:15-2:00'; break;
                        case 8: timeLabel = '2:00-2:45'; break;
                    }
                    
                    row.innerHTML = `<td>${timeLabel}</td>`;
                    
                    // Add subjects for each day
                    for (let day = 0; day < 5; day++) {
                        const cell = timetable[sectionId][day][period];
                        if (cell) {
                            if (cell.isBreak) {
                                row.innerHTML += `<td class="lunch-break">${cell.subject}<br><small>${cell.teacher}</small></td>`;
                            } else if (cell.isLab) {
                                row.innerHTML += `<td class="lab-period">${cell.subject}<br><small>${cell.teacher}</small></td>`;
                            } else if (period < 4) {
                                row.innerHTML += `<td class="first-half">${cell.subject}<br><small>${cell.teacher}</small></td>`;
                            } else if (period > 4) {
                                row.innerHTML += `<td class="second-half">${cell.subject}<br><small>${cell.teacher}</small></td>`;
                            } else {
                                row.innerHTML += `<td>${cell.subject}<br><small>${cell.teacher}</small></td>`;
                            }
                        } else {
                            // This should not happen in the optimized version
                            row.innerHTML += '<td class="free-period">Free<br><small>Error in scheduling</small></td>';
                        }
                    }
                    
                    timetableBody.appendChild(row);
                }
                
                // Update stats
                updateStats();
            }

            // Display teachers in the teachers card
            function displayTeachers() {
                const teachersList = document.getElementById('teachersList');
                teachersList.innerHTML = '';
                
                teachers.forEach(teacher => {
                    const teacherCard = document.createElement('div');
                    teacherCard.className = 'teacher-card';
                    
                    teacherCard.innerHTML = `
                        <div class="teacher-avatar">${teacher.name.charAt(0)}</div>
                        <div class="teacher-info">
                            <h3>${teacher.name} (${teacher.assignedPeriods}/${teacher.maxPeriodsPerWeek})</h3>
                            <div>
                                ${teacher.subjects.map((subj, index) => 
                                    `<span class="subject-badge">${subj}${index === 0 ? ' (P1)' : index === 1 ? ' (P2)' : ' (P3)'}</span>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                    
                    teachersList.appendChild(teacherCard);
                });
            }

            // Update statistics
            function updateStats() {
                let assignedClasses = 0;
                let freePeriods = 0;
                let totalTeacherLoad = 0;
                let totalClasses = 0;
                
                // Calculate total classes based on number of sections
                const sectionCount = parseInt(document.getElementById('sectionCount').value);
                totalClasses = sectionCount * 5 * 8; // 5 days, 8 teaching periods (excluding lunch)
                
                for (const sectionKey in timetable) {
                    for (let day = 0; day < 5; day++) {
                        for (let period = 0; period < 9; period++) {
                            if (timetable[sectionKey][day][period] && !timetable[sectionKey][day][period].isBreak) {
                                assignedClasses++;
                            } else if (!timetable[sectionKey][day][period] || 
                                      (timetable[sectionKey][day][period] && timetable[sectionKey][day][period].isBreak)) {
                                freePeriods++;
                            }
                        }
                    }
                }
                
                teachers.forEach(teacher => {
                    totalTeacherLoad += teacher.assignedPeriods;
                });
                
                const avgTeacherLoad = teachers.length > 0 ? (totalTeacherLoad / teachers.length).toFixed(1) : 0;
                
                document.getElementById('totalClasses').textContent = totalClasses;
                document.getElementById('assignedClasses').textContent = assignedClasses;
                document.getElementById('teacherLoad').textContent = avgTeacherLoad;
                document.getElementById('freePeriods').textContent = freePeriods;
            }

            // Initialize teacher specialization when teacher count changes
            document.getElementById('teacherCount').addEventListener('change', function() {
                initTeacherSpecialization(parseInt(this.value));
            });

            // Save data to Firebase
            async function saveToFirebase() {
                if (!firebaseInitialized) {
                    alert("Firebase is not initialized yet. Please wait a moment and try again.");
                    return;
                }
                
                try {
                    const saveData = {
                        sections: sections,
                        subjects: subjects,
                        teachers: teachers,
                        timetable: timetable,
                        teacherWorkload: teacherWorkload,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    await window.firebase.setDoc(window.firebase.doc(window.firebase.db, "timetable", "current"), saveData);
                    
                    const successMsg = document.createElement('div');
                    successMsg.className = 'success-message';
                    successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Data saved to cloud successfully!';
                    document.getElementById('timetableCard').prepend(successMsg);
                    
                    setTimeout(() => {
                        successMsg.remove();
                    }, 5000);
                    
                    console.log("Data saved to Firebase");
                } catch (error) {
                    console.error("Error saving to Firebase:", error);
                    alert("Error saving data to cloud. Please check console for details.");
                }
            }

            // Load data from Firebase
            async function loadFromFirebase() {
                if (!firebaseInitialized) {
                    alert("Firebase is not initialized yet. Please wait a moment and try again.");
                    return;
                }
                
                try {
                    const docRef = window.firebase.doc(window.firebase.db, "timetable", "current");
                    const docSnap = await window.firebase.getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        
                        // Restore the data
                        sections = data.sections || [];
                        subjects = data.subjects || {};
                        teachers = data.teachers || [];
                        timetable = data.timetable || {};
                        teacherWorkload = data.teacherWorkload || {};
                        
                        // Update UI with loaded data
                        updateUIWithLoadedData();
                        
                        // Show timetable card if we have data
                        if (Object.keys(timetable).length > 0) {
                            document.getElementById('timetableCard').style.display = 'block';
                            document.getElementById('teachersCard').style.display = 'block';
                            displayTimetable(sections[0].id);
                            displayTeachers();
                            updateStats();
                        }
                        
                        const successMsg = document.createElement('div');
                        successMsg.className = 'success-message';
                        successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Data loaded from cloud successfully!';
                        document.getElementById('timetableCard').prepend(successMsg);
                        
                        setTimeout(() => {
                            successMsg.remove();
                        }, 5000);
                        
                        console.log("Data loaded from Firebase");
                    } else {
                        console.log("No existing data found in Firebase");
                    }
                } catch (error) {
                    console.error("Error loading from Firebase:", error);
                    alert("Error loading data from cloud. Please check console for details.");
                }
            }

            // Update UI with loaded data
            function updateUIWithLoadedData() {
                // This function would need to be implemented to update the form fields
                // with the loaded data. For simplicity, we're just using the data internally.
                console.log("UI updated with loaded data");
            }
        });
    </script>
</body>
</html>